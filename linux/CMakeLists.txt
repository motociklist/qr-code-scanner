# Project-level configuration.
cmake_minimum_required(VERSION 3.10)
project(runner LANGUAGES CXX)

# Use the C++17 standard.
set(CMAKE_CXX_STANDARD 17)

# This value is used when generating builds using this file. It is
# passed as the version to find_package() for any dependencies.
set(PROJECT_VERSION "1.0.0")

# Application-level configuration.
set(BINARY_NAME "qr_code_scanner")

# Any new source files that you add to your application should be
# added to the files listed below so that they are included in the
# generated build.
set(APPLICATION_SOURCES
  "main.cc"
  "my_application.cc"
  "my_application.h"
  "${FLUTTER_MANAGED_DIR}/generated_plugin_registrant.cc"
  "${FLUTTER_MANAGED_DIR}/generated_plugin_registrant.h"
)

# This lists all the Flutter-related source files that are part of this
# project. Add any new Flutter source files to this list.
set(FLUTTER_SOURCES
  "${FLUTTER_MANAGED_DIR}/generated_plugin_registrant.cc"
  "${FLUTTER_MANAGED_DIR}/generated_plugin_registrant.h"
)

# Unique name for this target. This is used as a suffix for all targets
# generated by Flutter for this project.
set(EPHEMERAL_DIR "${CMAKE_CURRENT_SOURCE_DIR}/ephemeral")

# Flutter library and tool build rules.
set(FLUTTER_MANAGED_DIR "${EPHEMERAL_DIR}")

include(flutter/generated_plugins.cmake)

# Flutter-specific build configuration.
add_subdirectory(${FLUTTER_MANAGED_DIR} ${CMAKE_CURRENT_BINARY_DIR}/flutter)

# Application build configuration.
add_executable(${BINARY_NAME} ${APPLICATION_SOURCES})

# Apply the standard set of build settings. This can be removed for
# applications that need different build settings.
apply_standard_settings(${BINARY_NAME})

# Add preprocessor definitions for the build version.
target_compile_definitions(${BINARY_NAME} PRIVATE "FLUTTER_VERSION=\"${FLUTTER_VERSION}\"")
target_compile_definitions(${BINARY_NAME} PRIVATE "FLUTTER_VERSION_MAJOR=${FLUTTER_VERSION_MAJOR}")
target_compile_definitions(${BINARY_NAME} PRIVATE "FLUTTER_VERSION_MINOR=${FLUTTER_VERSION_MINOR}")
target_compile_definitions(${BINARY_NAME} PRIVATE "FLUTTER_VERSION_PATCH=${FLUTTER_VERSION_PATCH}")
target_compile_definitions(${BINARY_NAME} PRIVATE "FLUTTER_VERSION_BUILD=${FLUTTER_VERSION_BUILD}")

# Link the application's dependencies. The application runner uses
# GTK, so add GTK libraries as well.
target_link_libraries(${BINARY_NAME} PRIVATE flutter flutter_wrapper_app)
target_link_libraries(${BINARY_NAME} PRIVATE
  GTK3_LIBRARIES
)

# Run the Flutter tool prior to building. This generates the
# `generated_plugin_registrant.h` / `.cc` files, as well as the
# `generated_plugins.cmake` file, if needed.
add_custom_command(
  TARGET ${BINARY_NAME} PRE_BUILD
  COMMAND ${FLUTTER_TOOL_ENVIRONMENT} "${FLUTTER_ROOT}/packages/flutter_tools/bin/flutter_tools.dart"
      ${FLUTTER_BUILD_MODE}
      --target=lib/main.dart
      --output-dir="${PROJECT_BUILD_DIR}/flutter"
      --platform=linux
      --track-widget-creation=${TRACK_WIDGET_CREATION}
      --filesystem-scheme=${FLUTTER_FILESYSTEM_SCHEME}
      --packages="${PROJECT_DIR}/.dart_tool/package_config.json"
  VERBATIM
)

